import{O as t,C as i}from"./bsConstants-cgXdYAIG.js";import"./blockrain.jquery-oqjB4HyU.js";class n{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;paused;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.paused=!1,this.caches=e,this.debouncedOnSceneItemsChange=M(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=M(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=M(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await t.scene.isReady(),this.theme=await t.theme.getTheme(),S(this.theme,document),this.caches.includes(n.PLAYER)&&(this.playerId=await t.player.getId(),this.playerName=await t.player.getName(),this.playerColor=await t.player.getColor(),this.playerMetadata=await t.player.getMetadata(),this.playerRole=await t.player.getRole()),this.caches.includes(n.PARTY)&&(this.party=await t.party.getPlayers()),this.caches.includes(n.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await t.scene.items.getItems()),this.caches.includes(n.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await t.scene.getMetadata()),this.caches.includes(n.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(n.ROOMMETA)&&(this.roomMetadata=await t.room.getMetadata(),this.paused=this.roomMetadata[`${i.EXTENSIONID}/paused`])}KillHandlers(){this.caches.includes(n.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(n.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(n.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(n.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(n.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(n.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(n.SCENEMETA)&&(this.sceneMetadataHandler=t.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(n.SCENEITEMS)&&(this.sceneItemsHandler=t.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(n.SCENEGRID)&&(this.sceneGridHandler=t.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(n.PLAYER)&&(this.playerHandler=t.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(n.PARTY)&&(this.partyHandler=t.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(n.ROOMMETA)&&(this.roomHandler=t.room.onMetadataChange(async e=>{this.roomMetadata=e,this.playerRole==="PLAYER"&&(e[`${i.EXTENSIONID}/paused`]===!0&&this.paused===!1?(this.paused=!0,await t.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.roomMetadata[`${i.EXTENSIONID}/obscure`],disablePointerEvents:!1})):e[`${i.EXTENSIONID}/paused`]===!1&&this.paused===!0&&(this.paused=!1,await t.modal.close(i.PAUSEID))),this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=t.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=t.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await t.scene.items.getItems(),this.sceneMetadata=await t.scene.getMetadata(),this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole}async OnSceneItemsChange(e){this.sceneReady&&this.playerRole}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e&&this.SetupHandlers()}async OnPlayerChange(e){}async OnPartyChange(e){if(this.playerRole==="GM"){const s=document.getElementById("playerList"),u=s.querySelectorAll("li");for(const l of u){const r=l.id.split("_")[1];e.some(o=>o.id===r)||r!==this.playerId&&l.remove()}for(const l of e)if(!document.getElementById(`pl_${l.id}`)){const o=document.createElement("li");o.id=`pl_${l.id}`,o.classList.add("player-list-item"),o.innerText=l.name,s.appendChild(o)}}}async OnRoomMetadataChange(e){this.oldRoomMetadata=e}async OnThemeChange(e){S(e,document)}}const m=new n([n.ROOMMETA,n.PLAYER,n.PARTY]);function O(){const d=document.createElement("img");d.id="whatsNewButton",d.style.cursor="pointer",d.setAttribute("class","icon"),d.classList.add("clickable"),d.setAttribute("title","Whats New?"),d.setAttribute("src","/info.svg"),d.onclick=async function(){try{localStorage.setItem(i.VERSION,"true"),d.classList.remove("whats-new-shine")}catch{}await t.modal.open({id:i.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(i.VERSION)!=="true"&&d.classList.add("whats-new-shine")}catch{}return d}function M(d,e){let s;return function(){clearTimeout(s),s=setTimeout(()=>{d()},e)}}function S(d,e){const s=window.matchMedia("(prefers-color-scheme: dark)"),u=s.matches?"dark":"light",l=s.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var o=0;o<e.styleSheets[r].cssRules.length;o++){let a=e.styleSheets[r].cssRules[o];a&&a.media&&a.media.mediaText.includes("prefers-color-scheme")&&(d.mode=="LIGHT"?(a.media.appendMedium(`(prefers-color-scheme: ${u})`),a.media.mediaText.includes(l)&&a.media.deleteMedium(`(prefers-color-scheme: ${l})`)):d.mode=="DARK"&&(a.media.appendMedium(`(prefers-color-scheme: ${l})`),a.media.mediaText.includes(u)&&a.media.deleteMedium(`(prefers-color-scheme: ${u})`)))}}document.querySelector("#app").innerHTML=`
    <div class="header">Short Rest!</div><div id="whatsNew"></div>
    <table>
        <tr>
            <td>
                <button id="pauseButton">Pause</br>Game</button>
            </td>
            <td>
                <button id="hideViewButton">Hide View</br>Disabled</button>
            </td>
        </tr>
        <tr>
            <td>
                <div class="wrapper">
                    <label for="breakLength">Break Timer (Mins):</label>
                    <input type="number" id="breakLength" name="breakLength">
                </div>
            </td>
            <td>
                <button id="gameViewButton">Mini-Game</br>Disabled</button>
            </td>
        </tr>
    </table>
    </br>
    <textarea id="MessageTextarea" rows="4" placeholder="Add a message to the pause screen..."></textarea>
        
    <div id="attendanceBox">
        <ul id="playerList"></ul>
    </div>
    <div id="blockGameContainer" class="block-game"></div>
`;const w=420,g=document.getElementById("playerList"),b=document.getElementById("pauseButton"),p=document.getElementById("hideViewButton"),E=document.getElementById("gameViewButton"),f=document.getElementById("breakLength"),T=document.getElementById("MessageTextarea"),H=document.getElementById("bodyElement");let I=!1;t.onReady(async()=>{if(await m.InitializeCache(),m.SetupHandlers(),m.playerRole==="PLAYER"){await t.action.setHeight(50),document.querySelector("#app").innerHTML="<div class='header'>Enjoy your stay.</div>";return}else{let d=function(){const a=g.querySelectorAll("li");for(const c of a){const h=c.id.split("_")[1];m.party.some(y=>y.id===h)||h!==m.playerId&&c.remove()}for(const c of m.party)if(!document.getElementById(`pl_${c.id}`)){const y=document.createElement("li");y.id=`pl_${c.id}`,y.classList.add("player-list-item"),y.innerHTML=`${c.name} <div id="con_${c.connectionId}"></div>`,g.appendChild(y)}};document.getElementById("whatsNew").appendChild(O());let s=m.roomMetadata[`${i.EXTENSIONID}/paused`]??!1,u=m.roomMetadata[`${i.EXTENSIONID}/obscure`]??!1,l=m.roomMetadata[`${i.EXTENSIONID}/game`]??!1;f.value=m.roomMetadata[`${i.EXTENSIONID}/time`]??"0";const r=document.createElement("li");if(r.id=`pl_${m.playerId}`,r.classList.add("self-list-item"),r.innerText="Self",g.appendChild(r),r.onclick=async a=>{a.preventDefault(),I=!I,r.style.backgroundImage=I?"url(/check.svg)":"url(/cross.svg)",r.innerText=I?"Click to un-ready":"Click when ready!",await t.broadcast.sendMessage(i.TRANSPORT,I?i.READY:i.BUSY)},b.innerHTML=s?"Resume</br>Game":"Pause</br>Game",s){const a=g.querySelectorAll("li");for(const c of a)c.style.backgroundImage=s?"url(/cross.svg)":"url(/check.svg)";p.disabled=s,E.disabled=s,f.disabled=s,T.disabled=s}b.onclick=async a=>{a.preventDefault(),s=!s,b.innerHTML=s?"Resume</br>Game":"Pause</br>Game";const c=g.querySelectorAll("li");for(const h of c)h.style.backgroundImage=s?"url(/cross.svg)":"url(/check.svg)";p.disabled=s,E.disabled=s,f.disabled=s,T.disabled=s,t.room.setMetadata({[`${i.EXTENSIONID}/paused`]:!!s}),s&&setTimeout(async()=>{await t.broadcast.sendMessage(i.MESSAGE,T.value)},2e3),await o()},p.innerHTML=u?"Hide View</br>Enabled":"Hide View</br>Disabled",p.onclick=async a=>{a.preventDefault(),u=!u,p.innerHTML=u?"Hide View</br>Enabled":"Hide View</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/obscure`]:!!u})},E.innerHTML=l?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",E.onclick=async a=>{a.preventDefault(),l=!l,E.innerHTML=l?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/game`]:!!l})},f.onblur=async()=>{const a=f.value??0;t.room.setMetadata({[`${i.EXTENSIONID}/time`]:a})},d(),await o(),t.broadcast.onMessage(i.TRANSPORT,async a=>{if(m.playerRole==="GM"){const c=a.connectionId,h=m.party.find(y=>y.connectionId===c);if(h){const y=`pl_${h.id}`,R=document.getElementById(y);R&&(R.style.backgroundImage=a.data===i.READY?"url(/check.svg)":"url(/cross.svg)")}}}),t.broadcast.onMessage(i.SCORE,async a=>{const c=`con_${a.connectionId}`,h=document.getElementById(c);h&&(h.innerText=`Score: ${a.data}`)});async function o(){s&&l?(await t.action.setHeight(w+400),H.style.height="100%",document.getElementById("blockGameContainer").style.display="block",$(".block-game").blockrain({autoplay:!1,autoplayRestart:!1,theme:"candy",playText:"Pass some time during the break?",playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:async function(){await t.broadcast.sendMessage(i.SCORE,0)},onRestart:function(){},onLine:async function(a,c,h){await t.broadcast.sendMessage(i.SCORE,h)}})):(await t.action.setHeight(w),document.getElementById("blockGameContainer").style.display="none",H.style.height="")}}});
