import{O as t,C as i}from"./bsConstants-cgXdYAIG.js";import{$ as C}from"./blockrain.jquery-DqERG-6C.js";class d{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;paused;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.paused=!1,this.caches=e,this.debouncedOnSceneItemsChange=b(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=b(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=b(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await t.scene.isReady(),this.theme=await t.theme.getTheme(),N(this.theme,document),this.caches.includes(d.PLAYER)&&(this.playerId=await t.player.getId(),this.playerName=await t.player.getName(),this.playerColor=await t.player.getColor(),this.playerMetadata=await t.player.getMetadata(),this.playerRole=await t.player.getRole()),this.caches.includes(d.PARTY)&&(this.party=await t.party.getPlayers()),this.caches.includes(d.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await t.scene.items.getItems()),this.caches.includes(d.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await t.scene.getMetadata()),this.caches.includes(d.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(d.ROOMMETA)&&(this.roomMetadata=await t.room.getMetadata(),this.paused=this.roomMetadata[`${i.EXTENSIONID}/paused`])}KillHandlers(){this.caches.includes(d.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(d.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(d.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(d.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(d.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(d.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(d.SCENEMETA)&&(this.sceneMetadataHandler=t.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(d.SCENEITEMS)&&(this.sceneItemsHandler=t.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(d.SCENEGRID)&&(this.sceneGridHandler=t.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(d.PLAYER)&&(this.playerHandler=t.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(d.PARTY)&&(this.partyHandler=t.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(d.ROOMMETA)&&(this.roomHandler=t.room.onMetadataChange(async e=>{this.roomMetadata=e,this.playerRole==="PLAYER"&&(e[`${i.EXTENSIONID}/paused`]===!0&&this.paused===!1?(this.paused=!0,await t.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.roomMetadata[`${i.EXTENSIONID}/obscure`],disablePointerEvents:!1})):e[`${i.EXTENSIONID}/paused`]===!1&&this.paused===!0&&(this.paused=!1,await t.modal.close(i.PAUSEID))),this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=t.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=t.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await t.scene.items.getItems(),this.sceneMetadata=await t.scene.getMetadata(),this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole}async OnSceneItemsChange(e){this.sceneReady&&this.playerRole}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e&&this.SetupHandlers()}async OnPlayerChange(e){}async OnPartyChange(e){if(this.playerRole==="GM"){const y=document.getElementById("playerList"),g=y.querySelectorAll("li");for(const a of g){const h=a.id.split("_")[1];e.some(o=>o.id===h)||h!==this.playerId&&a.remove()}for(const a of e)if(!document.getElementById(`pl_${a.id}`)){const o=document.createElement("li");o.id=`pl_${a.id}`,o.classList.add("player-list-item"),o.innerText=a.name,y.appendChild(o)}}}async OnRoomMetadataChange(e){this.oldRoomMetadata=e}async OnThemeChange(e){N(e,document)}}const m=new d([d.ROOMMETA,d.PLAYER,d.PARTY]);function D(){const c=document.createElement("img");c.id="whatsNewButton",c.style.cursor="pointer",c.setAttribute("class","icon"),c.classList.add("clickable"),c.setAttribute("title","Whats New?"),c.setAttribute("src","/info.svg"),c.onclick=async function(){try{localStorage.setItem(i.VERSION,"true"),c.classList.remove("whats-new-shine")}catch{}await t.modal.open({id:i.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(i.VERSION)!=="true"&&c.classList.add("whats-new-shine")}catch{}return c}function b(c,e){let y;return function(){clearTimeout(y),y=setTimeout(()=>{c()},e)}}function N(c,e){const y=window.matchMedia("(prefers-color-scheme: dark)"),g=y.matches?"dark":"light",a=y.matches?"light":"dark";for(var h=0;h<e.styleSheets.length;h++)for(var o=0;o<e.styleSheets[h].cssRules.length;o++){let l=e.styleSheets[h].cssRules[o];l&&l.media&&l.media.mediaText.includes("prefers-color-scheme")&&(c.mode=="LIGHT"?(l.media.appendMedium(`(prefers-color-scheme: ${g})`),l.media.mediaText.includes(a)&&l.media.deleteMedium(`(prefers-color-scheme: ${a})`)):c.mode=="DARK"&&(l.media.appendMedium(`(prefers-color-scheme: ${a})`),l.media.mediaText.includes(g)&&l.media.deleteMedium(`(prefers-color-scheme: ${g})`)))}}document.querySelector("#app").innerHTML=`
    <div class="header">Short Rest!</div><div id="whatsNew"></div>
    <table>
        <tr>
            <td>
                <button id="pauseButton">Pause</br>Game</button>
            </td>
            <td>
                <button id="hideViewButton">Hide View</br>Disabled</button>
            </td>
        </tr>
        <tr>
            <td>
                <div class="wrapper">
                    <label for="breakLength">Break Timer (Mins):</label>
                    <div id="timeWrapper">
                        <input type="number" id="breakLength" name="breakLength" maxlength="2" min="0">
                        <div id="breakTimer">--:--</div>
                    </div>
                </div>
            </td>
            <td>
                <button id="gameViewButton">Mini-Game</br>Disabled</button>
            </td>
        </tr>
    </table>
    </br>
    <textarea id="MessageTextarea" rows="4" placeholder="Add a message to the pause screen..."></textarea>
        
    <div id="attendanceBox">
        <ul id="playerList"></ul>
    </div>
    <div id="blockGameContainer" class="block-game"></div>
`;const v=420,E=document.getElementById("playerList"),R=document.getElementById("pauseButton"),f=document.getElementById("hideViewButton"),I=document.getElementById("gameViewButton"),p=document.getElementById("breakLength"),M=document.getElementById("breakTimer"),S=document.getElementById("MessageTextarea"),A=document.getElementById("bodyElement");let T=!1,w;t.onReady(async()=>{if(await m.InitializeCache(),m.SetupHandlers(),m.playerRole==="PLAYER"){await t.action.setHeight(50),document.querySelector("#app").innerHTML="<div class='header'>Enjoy your stay.</div>";return}else{let c=function(){const s=E.querySelectorAll("li");for(const n of s){const r=n.id.split("_")[1];m.party.some(u=>u.id===r)||r!==m.playerId&&n.remove()}for(const n of m.party)if(!document.getElementById(`pl_${n.id}`)){const u=document.createElement("li");u.id=`pl_${n.id}`,u.classList.add("player-list-item"),u.innerHTML=`${n.name} <div class="player-score-item" id="con_${n.connectionId}"></div>`,E.appendChild(u)}},e=function(s){let n=s*60;y(n),w=setInterval(()=>{n--,n<=0?(clearInterval(w),M.innerText="Time is up!"):y(n)},1e3)},y=function(s){const n=Math.floor(s/60),r=s%60,u=`${String(n).padStart(2,"0")}:${String(r).padStart(2,"0")}`;M.innerText=u};document.getElementById("whatsNew").appendChild(D());let a=m.roomMetadata[`${i.EXTENSIONID}/paused`]??!1,h=m.roomMetadata[`${i.EXTENSIONID}/obscure`]??!1,o=m.roomMetadata[`${i.EXTENSIONID}/game`]??!1;p.value=m.roomMetadata[`${i.EXTENSIONID}/time`]??"0";const l=document.createElement("li");if(l.id=`pl_${m.playerId}`,l.classList.add("self-list-item"),l.innerText="Self",E.appendChild(l),l.onclick=async s=>{s.preventDefault(),a&&(T=!T,l.style.backgroundImage=T?"url(/check.svg)":"url(/cross.svg)",l.innerText=T?"Click to un-ready":"Click when ready!",await t.broadcast.sendMessage(i.TRANSPORT,T?i.READY:i.BUSY))},R.innerHTML=a?"Resume</br>Game":"Pause</br>Game",a){const s=parseInt(p.value);s>0?e(s):M.innerText="--:--";const n=E.querySelectorAll("li");for(const r of n)r.style.backgroundImage=a?"url(/cross.svg)":"url(/check.svg)";l.innerText="Click when ready!",f.disabled=a,I.disabled=a,p.disabled=a,S.disabled=a}else{const s=E.querySelectorAll(".player-score-item");for(const n of s)n.innerText=""}R.onclick=async s=>{s.preventDefault(),a=!a,R.innerHTML=a?"Resume</br>Game":"Pause</br>Game";const n=E.querySelectorAll("li");for(const r of n)r.style.backgroundImage=a?"url(/cross.svg)":"url(/check.svg)";if(f.disabled=a,I.disabled=a,p.disabled=a,S.disabled=a,t.room.setMetadata({[`${i.EXTENSIONID}/paused`]:!!a}),a){const r=parseInt(p.value);r>0?e(r):M.innerText="--:--",l.innerText="Click when ready!",setTimeout(async()=>{await t.broadcast.sendMessage(i.MESSAGE,S.value)},2e3)}else M.innerText="--:--",clearInterval(w),l.innerText="Self";await H()},f.innerHTML=h?"Hide View</br>Enabled":"Hide View</br>Disabled",f.onclick=async s=>{s.preventDefault(),h=!h,f.innerHTML=h?"Hide View</br>Enabled":"Hide View</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/obscure`]:!!h})},I.innerHTML=o?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",I.onclick=async s=>{s.preventDefault(),o=!o,I.innerHTML=o?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/game`]:!!o})},p.oninput=async()=>{p.value=p.value.slice(0,2)},p.onblur=async()=>{const s=p.value??0;t.room.setMetadata({[`${i.EXTENSIONID}/time`]:s})},c(),await H(),t.broadcast.onMessage(i.TRANSPORT,async s=>{if(m.playerRole==="GM"){const n=s.connectionId,r=m.party.find(u=>u.connectionId===n);if(r){const u=`pl_${r.id}`,O=document.getElementById(u);O&&(O.style.backgroundImage=s.data===i.READY?"url(/check.svg)":"url(/cross.svg)")}}}),t.broadcast.onMessage(i.SCORE,async s=>{const n=`con_${s.connectionId}`,r=document.getElementById(n);r&&(r.innerText=`Score: ${s.data}`)});async function H(){a&&o?(await t.action.setHeight(v+400),A.style.height="100%",document.getElementById("blockGameContainer").style.display="block",C(".block-game").blockrain({autoplay:!1,autoplayRestart:!1,theme:"candy",playText:"Pass some time during the break?",playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:async function(){await t.broadcast.sendMessage(i.SCORE,0)},onRestart:function(){},onLine:async function(s,n,r){await t.broadcast.sendMessage(i.SCORE,r)}})):(await t.action.setHeight(v),document.getElementById("blockGameContainer").style.display="none",A.style.height="")}}});
