import{O as t,C as i,F as u,$ as y}from"./bsWorldTime-uy-e-eiY.js";class d{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerPreviousRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;paused;caches;USER_REGISTERED;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;transportHandler;scoreHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.playerPreviousRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.paused=!1,this.USER_REGISTERED=!1,this.caches=e,this.debouncedOnSceneItemsChange=m(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=m(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=m(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await t.scene.isReady(),this.theme=await t.theme.getTheme(),T(this.theme,document),this.caches.includes(d.PLAYER)&&(this.playerId=await t.player.getId(),this.playerName=await t.player.getName(),this.playerColor=await t.player.getColor(),this.playerMetadata=await t.player.getMetadata(),this.playerRole=await t.player.getRole(),this.playerPreviousRole=this.playerRole),this.caches.includes(d.PARTY)&&(this.party=await t.party.getPlayers()),this.caches.includes(d.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await t.scene.items.getItems()),this.caches.includes(d.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await t.scene.getMetadata()),this.caches.includes(d.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(d.ROOMMETA)&&(this.roomMetadata=await t.room.getMetadata(),this.paused=this.roomMetadata[`${i.EXTENSIONID}/paused`]),await this.CheckRegistration()}KillHandlers(){this.caches.includes(d.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(d.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(d.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(d.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(d.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(d.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler(),this.transportHandler!==void 0&&this.transportHandler(),this.scoreHandler!==void 0&&this.scoreHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(d.SCENEMETA)&&(this.sceneMetadataHandler=t.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(d.SCENEITEMS)&&(this.sceneItemsHandler=t.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(d.SCENEGRID)&&(this.sceneGridHandler=t.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(d.PLAYER)&&(this.playerHandler=t.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(d.PARTY)&&(this.partyHandler=t.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(d.ROOMMETA)&&(this.roomHandler=t.room.onMetadataChange(async e=>{this.roomMetadata=e,this.playerRole==="PLAYER"&&(e[`${i.EXTENSIONID}/paused`]===!0&&this.paused===!1?(this.paused=!0,await t.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.roomMetadata[`${i.EXTENSIONID}/obscure`],disablePointerEvents:!1})):e[`${i.EXTENSIONID}/paused`]===!1&&this.paused===!0&&(this.paused=!1,await t.modal.close(i.PAUSEID))),this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=t.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=t.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await t.scene.items.getItems(),this.sceneMetadata=await t.scene.getMetadata(),this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)})),this.transportHandler=t.broadcast.onMessage(i.TRANSPORT,async e=>{if(l.playerRole==="GM"){const s=e.connectionId,n=l.party.find(a=>a.connectionId===s);if(n){const a=`pl_${n.id}`,r=document.getElementById(a);r&&(r.style.backgroundImage=e.data===i.READY?"url(/check.svg)":"url(/cross.svg)")}}}),this.scoreHandler=t.broadcast.onMessage(i.SCORE,async e=>{const s=`con_${e.connectionId}`,n=document.getElementById(s);n&&(n.innerText=`Score: ${e.data}`)})}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e&&this.SetupHandlers()}async OnPlayerChange(e){e.role==="GM"&&this.playerPreviousRole==="PLAYER"?(E.MAINAPP.innerHTML=i.BASEHTML,await t.action.setHeight(E.baseHeight),await E.InitiateGM()):e.role==="PLAYER"&&this.playerPreviousRole==="GM"&&await E.InitiatePlayer(),this.playerPreviousRole=e.role}async OnPartyChange(e){if(this.playerRole==="GM"){const s=document.getElementById("playerList"),n=s.querySelectorAll("li");for(const a of n){const r=a.id.split("_")[1];e.some(o=>o.id===r)||r!==this.playerId&&a.remove()}for(const a of e)if(!document.getElementById(`pl_${a.id}`)){const o=document.createElement("li");o.id=`pl_${a.id}`,o.classList.add("player-list-item"),o.innerText=a.name,s.appendChild(o)}}}async OnRoomMetadataChange(e){this.oldRoomMetadata=e}async OnThemeChange(e){T(e,document)}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",s={owlbearid:l.playerId},n={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:i.ANONAUTH,"x-manuel":e}),body:JSON.stringify(s)},a=await fetch(i.CHECKREGISTRATION,n);if(!a.ok){const o=await a.json();console.error("Error:",o);return}(await a.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const l=new d([d.ROOMMETA,d.PLAYER,d.PARTY]);function I(){const c=document.createElement("img");return c.id="PatreonButton",c.setAttribute("class","icon"),c.classList.add("patreon-clickable"),c.setAttribute("title",l.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),c.setAttribute("src",l.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),c.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},c}function m(c,e){let s;return function(){clearTimeout(s),s=setTimeout(()=>{c()},e)}}function T(c,e){const s=window.matchMedia("(prefers-color-scheme: dark)"),n=s.matches?"dark":"light",a=s.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var o=0;o<e.styleSheets[r].cssRules.length;o++){let h=e.styleSheets[r].cssRules[o];h&&h.media&&h.media.mediaText.includes("prefers-color-scheme")&&(c.mode=="LIGHT"?(h.media.appendMedium(`(prefers-color-scheme: ${n})`),h.media.mediaText.includes(a)&&h.media.deleteMedium(`(prefers-color-scheme: ${a})`)):c.mode=="DARK"&&(h.media.appendMedium(`(prefers-color-scheme: ${a})`),h.media.mediaText.includes(n)&&h.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}t.onReady(async()=>{await l.InitializeCache(),l.SetupHandlers(),l.playerRole==="PLAYER"?await E.InitiatePlayer():await E.InitiateGM(),document.getElementById("patreonContainer").appendChild(I())});class g{baseHeight=420;paused=!1;pausedAt="";obscure=!1;game=!1;selfReady;timerId;version;MAINAPP=document.getElementById("app");PLAYERLISTING=document.getElementById("playerList");PAUSEBUTTON=document.getElementById("pauseButton");HIDEVIEWBUTTON=document.getElementById("hideViewButton");GAMEVIEWBUTTON=document.getElementById("gameViewButton");BREAKLENGTHBUTTON=document.getElementById("breakLength");BREAKTIMER=document.getElementById("breakTimer");SENDMESSAGE=document.getElementById("sendMessage");MESSAGETEXT=document.getElementById("MessageTextarea");BODYELEMENT=document.getElementById("bodyElement");constructor(e){this.version=`SHORTREST-${e}`,this.selfReady=!1,this.timerId=0}RetrieveSettings(){this.paused=l.roomMetadata[`${i.EXTENSIONID}/paused`]??!1,this.pausedAt=l.roomMetadata[`${i.EXTENSIONID}/pausedAt`]??"",this.obscure=l.roomMetadata[`${i.EXTENSIONID}/obscure`]??!1,this.game=l.roomMetadata[`${i.EXTENSIONID}/game`]??!1}async InitiateGM(){this.RetrieveSettings(),this.PLAYERLISTING=document.getElementById("playerList"),this.PAUSEBUTTON=document.getElementById("pauseButton"),this.HIDEVIEWBUTTON=document.getElementById("hideViewButton"),this.GAMEVIEWBUTTON=document.getElementById("gameViewButton"),this.BREAKLENGTHBUTTON=document.getElementById("breakLength"),this.BREAKTIMER=document.getElementById("breakTimer"),this.SENDMESSAGE=document.getElementById("sendMessage"),this.MESSAGETEXT=document.getElementById("MessageTextarea"),this.BODYELEMENT=document.getElementById("bodyElement"),this.BREAKLENGTHBUTTON.value=l.roomMetadata[`${i.EXTENSIONID}/time`]??"0";const e=document.createElement("li");if(e.id=`pl_${l.playerId}`,e.classList.add("self-list-item"),e.innerText="Self",this.PLAYERLISTING.appendChild(e),e.onclick=async s=>{s.preventDefault(),this.paused&&(this.selfReady=!this.selfReady,e.style.backgroundImage=this.selfReady?"url(/check.svg)":"url(/cross.svg)",e.innerText=this.selfReady?"Click to un-ready":"Click when ready!",await t.broadcast.sendMessage(i.TRANSPORT,this.selfReady?i.READY:i.BUSY))},this.SENDMESSAGE.onclick=async s=>{s.preventDefault(),this.MESSAGETEXT.value&&this.paused&&(await t.broadcast.sendMessage(i.MESSAGE,this.MESSAGETEXT.value),this.MESSAGETEXT.value="",this.SENDMESSAGE.classList.add("flashing-text"),setTimeout(async()=>{this.SENDMESSAGE.classList.remove("flashing-text")},1e3))},this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game",this.paused){const s=new Date(await u()),n=new Date(this.pausedAt),a=Math.round((s.getTime()-n.getTime())/1e3),o=parseInt(this.BREAKLENGTHBUTTON.value)*60-a;o>0?this.StartCountdown(o):this.BREAKTIMER.innerText="--:--";const h=this.PLAYERLISTING.querySelectorAll("li");for(const p of h)p.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";e.innerText="Click when ready!",this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused}else{const s=this.PLAYERLISTING.querySelectorAll(".player-score-item");for(const n of s)n.innerText=""}this.PAUSEBUTTON.onclick=async s=>{s.preventDefault(),this.paused=!this.paused,this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game";const n=this.PLAYERLISTING.querySelectorAll("li");for(const r of n)r.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused;const a=await u();if(t.room.setMetadata({[`${i.EXTENSIONID}/paused`]:!!this.paused,[`${i.EXTENSIONID}/pausedAt`]:a}),this.paused){const r=parseInt(this.BREAKLENGTHBUTTON.value)*60;r>0?this.StartCountdown(r):this.BREAKTIMER.innerText="--:--",e.innerText="Click when ready!",setTimeout(async()=>{this.MESSAGETEXT.value?await t.broadcast.sendMessage(i.MESSAGE,this.MESSAGETEXT.value):await t.broadcast.sendMessage(i.MESSAGE,"The session has been paused.")},2e3)}else this.BREAKTIMER.innerText="--:--",clearInterval(this.timerId),e.innerText="Self";await this.StartGame()},this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",this.HIDEVIEWBUTTON.onclick=async s=>{s.preventDefault(),this.obscure=!this.obscure,this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/obscure`]:!!this.obscure})},this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",this.GAMEVIEWBUTTON.onclick=async s=>{s.preventDefault(),this.game=!this.game,this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/game`]:!!this.game})},this.BREAKLENGTHBUTTON.oninput=async()=>{this.BREAKLENGTHBUTTON.value=this.BREAKLENGTHBUTTON.value.slice(0,2)},this.BREAKLENGTHBUTTON.onblur=async()=>{const s=this.BREAKLENGTHBUTTON.value??0;t.room.setMetadata({[`${i.EXTENSIONID}/time`]:s})},this.RefreshPlayerList(),await this.StartGame()}RefreshPlayerList(){const e=this.PLAYERLISTING.querySelectorAll("li");for(const s of e){const n=s.id.split("_")[1];l.party.some(a=>a.id===n)||n!==l.playerId&&s.remove()}for(const s of l.party)if(!document.getElementById(`pl_${s.id}`)){const a=document.createElement("li");a.id=`pl_${s.id}`,a.classList.add("player-list-item"),a.innerHTML=`${s.name} <div class="player-score-item" id="con_${s.connectionId}"></div>`,this.PLAYERLISTING.appendChild(a)}}StartCountdown(e){this.UpdateTimer(e),this.timerId=setInterval(()=>{e--,e<=0?(clearInterval(this.timerId),this.BREAKTIMER.innerText="Time is up!"):this.UpdateTimer(e)},1e3)}UpdateTimer(e){const s=Math.floor(e/60),n=e%60,a=`${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`;this.BREAKTIMER.innerText=a}async StartGame(){this.paused&&this.game?(await t.action.setHeight(this.baseHeight+400),this.BODYELEMENT.style.height="100%",document.getElementById("blockGameContainer").style.display="block",document.getElementById("blockGameControls").style.display="block",y(".block-game").blockrain({autoplay:!1,autoplayRestart:!1,theme:"candy",playText:"Pass some time during the break?",playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:async function(){await t.broadcast.sendMessage(i.SCORE,0)},onRestart:function(){},onLine:async function(e,s,n){await t.broadcast.sendMessage(i.SCORE,n)}})):(await t.action.setHeight(this.baseHeight),document.getElementById("blockGameContainer").style.display="none",document.getElementById("blockGameControls").style.display="none",this.BODYELEMENT.style.height="")}async InitiatePlayer(){this.RetrieveSettings(),await t.action.setHeight(50),document.querySelector("#app").innerHTML="<div class='header'>Enjoy your stay.<div id='patreonContainer'></div></div>",this.paused&&(l.paused=!0,await t.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.obscure,disablePointerEvents:!1}))}}const E=new g("1.03");
