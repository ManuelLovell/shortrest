import{O as t,C as i}from"./bsConstants-DkgTi0D1.js";import{$ as T}from"./blockrain.jquery-2qJd7CXZ.js";class d{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerPreviousRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;paused;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;transportHandler;scoreHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.playerPreviousRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.paused=!1,this.caches=e,this.debouncedOnSceneItemsChange=E(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=E(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=E(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await t.scene.isReady(),this.theme=await t.theme.getTheme(),u(this.theme,document),this.caches.includes(d.PLAYER)&&(this.playerId=await t.player.getId(),this.playerName=await t.player.getName(),this.playerColor=await t.player.getColor(),this.playerMetadata=await t.player.getMetadata(),this.playerRole=await t.player.getRole(),this.playerPreviousRole=this.playerRole),this.caches.includes(d.PARTY)&&(this.party=await t.party.getPlayers()),this.caches.includes(d.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await t.scene.items.getItems()),this.caches.includes(d.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await t.scene.getMetadata()),this.caches.includes(d.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(d.ROOMMETA)&&(this.roomMetadata=await t.room.getMetadata(),this.paused=this.roomMetadata[`${i.EXTENSIONID}/paused`])}KillHandlers(){this.caches.includes(d.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(d.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(d.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(d.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(d.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(d.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler(),this.transportHandler!==void 0&&this.transportHandler(),this.scoreHandler!==void 0&&this.scoreHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(d.SCENEMETA)&&(this.sceneMetadataHandler=t.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(d.SCENEITEMS)&&(this.sceneItemsHandler=t.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(d.SCENEGRID)&&(this.sceneGridHandler=t.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(d.PLAYER)&&(this.playerHandler=t.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(d.PARTY)&&(this.partyHandler=t.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(d.ROOMMETA)&&(this.roomHandler=t.room.onMetadataChange(async e=>{this.roomMetadata=e,this.playerRole==="PLAYER"&&(e[`${i.EXTENSIONID}/paused`]===!0&&this.paused===!1?(this.paused=!0,await t.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.roomMetadata[`${i.EXTENSIONID}/obscure`],disablePointerEvents:!1})):e[`${i.EXTENSIONID}/paused`]===!1&&this.paused===!0&&(this.paused=!1,await t.modal.close(i.PAUSEID))),this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=t.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=t.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await t.scene.items.getItems(),this.sceneMetadata=await t.scene.getMetadata(),this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)})),this.transportHandler=t.broadcast.onMessage(i.TRANSPORT,async e=>{if(o.playerRole==="GM"){const s=e.connectionId,a=o.party.find(n=>n.connectionId===s);if(a){const n=`pl_${a.id}`,l=document.getElementById(n);l&&(l.style.backgroundImage=e.data===i.READY?"url(/check.svg)":"url(/cross.svg)")}}}),this.scoreHandler=t.broadcast.onMessage(i.SCORE,async e=>{const s=`con_${e.connectionId}`,a=document.getElementById(s);a&&(a.innerText=`Score: ${e.data}`)})}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e&&this.SetupHandlers()}async OnPlayerChange(e){e.role==="GM"&&this.playerPreviousRole==="PLAYER"?(m.MAINAPP.innerHTML=i.BASEHTML,await t.action.setHeight(m.baseHeight),await m.InitiateGM()):e.role==="PLAYER"&&this.playerPreviousRole==="GM"&&await m.InitiatePlayer(),this.playerPreviousRole=e.role}async OnPartyChange(e){if(this.playerRole==="GM"){const s=document.getElementById("playerList"),a=s.querySelectorAll("li");for(const n of a){const l=n.id.split("_")[1];e.some(c=>c.id===l)||l!==this.playerId&&n.remove()}for(const n of e)if(!document.getElementById(`pl_${n.id}`)){const c=document.createElement("li");c.id=`pl_${n.id}`,c.classList.add("player-list-item"),c.innerText=n.name,s.appendChild(c)}}}async OnRoomMetadataChange(e){this.oldRoomMetadata=e}async OnThemeChange(e){u(e,document)}}const o=new d([d.ROOMMETA,d.PLAYER,d.PARTY]);function y(){const r=document.createElement("img");r.id="whatsNewButton",r.style.cursor="pointer",r.setAttribute("class","icon"),r.classList.add("clickable"),r.setAttribute("title","Whats New?"),r.setAttribute("src","/info.svg"),r.onclick=async function(){try{localStorage.setItem(i.VERSION,"true"),r.classList.remove("whats-new-shine")}catch{}await t.modal.open({id:i.EXTENSIONWHATSNEW,url:"/bswhatsnew.html",height:500,width:350})};try{localStorage.getItem(i.VERSION)!=="true"&&r.classList.add("whats-new-shine")}catch{}return r}function E(r,e){let s;return function(){clearTimeout(s),s=setTimeout(()=>{r()},e)}}function u(r,e){const s=window.matchMedia("(prefers-color-scheme: dark)"),a=s.matches?"dark":"light",n=s.matches?"light":"dark";for(var l=0;l<e.styleSheets.length;l++)for(var c=0;c<e.styleSheets[l].cssRules.length;c++){let h=e.styleSheets[l].cssRules[c];h&&h.media&&h.media.mediaText.includes("prefers-color-scheme")&&(r.mode=="LIGHT"?(h.media.appendMedium(`(prefers-color-scheme: ${a})`),h.media.mediaText.includes(n)&&h.media.deleteMedium(`(prefers-color-scheme: ${n})`)):r.mode=="DARK"&&(h.media.appendMedium(`(prefers-color-scheme: ${n})`),h.media.mediaText.includes(a)&&h.media.deleteMedium(`(prefers-color-scheme: ${a})`)))}}t.onReady(async()=>{await o.InitializeCache(),o.SetupHandlers(),o.playerRole==="PLAYER"?await m.InitiatePlayer():await m.InitiateGM()});class I{baseHeight=420;paused=!1;obscure=!1;game=!1;selfReady;timerId;version;MAINAPP=document.getElementById("app");PLAYERLISTING=document.getElementById("playerList");PAUSEBUTTON=document.getElementById("pauseButton");HIDEVIEWBUTTON=document.getElementById("hideViewButton");GAMEVIEWBUTTON=document.getElementById("gameViewButton");BREAKLENGTHBUTTON=document.getElementById("breakLength");BREAKTIMER=document.getElementById("breakTimer");SENDMESSAGE=document.getElementById("sendMessage");MESSAGETEXT=document.getElementById("MessageTextarea");BODYELEMENT=document.getElementById("bodyElement");constructor(e){this.version=`SHORTREST-${e}`,this.selfReady=!1,this.timerId=0}async RetrieveSettings(){this.paused=o.roomMetadata[`${i.EXTENSIONID}/paused`]??!1,this.obscure=o.roomMetadata[`${i.EXTENSIONID}/obscure`]??!1,this.game=o.roomMetadata[`${i.EXTENSIONID}/game`]??!1}async InitiateGM(){this.RetrieveSettings(),this.PLAYERLISTING=document.getElementById("playerList"),this.PAUSEBUTTON=document.getElementById("pauseButton"),this.HIDEVIEWBUTTON=document.getElementById("hideViewButton"),this.GAMEVIEWBUTTON=document.getElementById("gameViewButton"),this.BREAKLENGTHBUTTON=document.getElementById("breakLength"),this.BREAKTIMER=document.getElementById("breakTimer"),this.SENDMESSAGE=document.getElementById("sendMessage"),this.MESSAGETEXT=document.getElementById("MessageTextarea"),this.BODYELEMENT=document.getElementById("bodyElement"),document.getElementById("whatsNew").appendChild(y()),this.BREAKLENGTHBUTTON.value=o.roomMetadata[`${i.EXTENSIONID}/time`]??"0";const s=document.createElement("li");if(s.id=`pl_${o.playerId}`,s.classList.add("self-list-item"),s.innerText="Self",this.PLAYERLISTING.appendChild(s),s.onclick=async a=>{a.preventDefault(),this.paused&&(this.selfReady=!this.selfReady,s.style.backgroundImage=this.selfReady?"url(/check.svg)":"url(/cross.svg)",s.innerText=this.selfReady?"Click to un-ready":"Click when ready!",await t.broadcast.sendMessage(i.TRANSPORT,this.selfReady?i.READY:i.BUSY))},this.SENDMESSAGE.onclick=async a=>{a.preventDefault(),this.MESSAGETEXT.value&&this.paused&&(await t.broadcast.sendMessage(i.MESSAGE,this.MESSAGETEXT.value),this.MESSAGETEXT.value="",this.SENDMESSAGE.classList.add("flashing-text"),setTimeout(async()=>{this.SENDMESSAGE.classList.remove("flashing-text")},1e3))},this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game",this.paused){const a=parseInt(this.BREAKLENGTHBUTTON.value);a>0?this.StartCountdown(a):this.BREAKTIMER.innerText="--:--";const n=this.PLAYERLISTING.querySelectorAll("li");for(const l of n)l.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";s.innerText="Click when ready!",this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused}else{const a=this.PLAYERLISTING.querySelectorAll(".player-score-item");for(const n of a)n.innerText=""}this.PAUSEBUTTON.onclick=async a=>{a.preventDefault(),this.paused=!this.paused,this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game";const n=this.PLAYERLISTING.querySelectorAll("li");for(const l of n)l.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";if(this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused,t.room.setMetadata({[`${i.EXTENSIONID}/paused`]:!!this.paused}),this.paused){const l=parseInt(this.BREAKLENGTHBUTTON.value);l>0?this.StartCountdown(l):this.BREAKTIMER.innerText="--:--",s.innerText="Click when ready!",setTimeout(async()=>{this.MESSAGETEXT.value?await t.broadcast.sendMessage(i.MESSAGE,this.MESSAGETEXT.value):await t.broadcast.sendMessage(i.MESSAGE,"The session has been paused.")},2e3)}else this.BREAKTIMER.innerText="--:--",clearInterval(this.timerId),s.innerText="Self";await this.StartGame()},this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",this.HIDEVIEWBUTTON.onclick=async a=>{a.preventDefault(),this.obscure=!this.obscure,this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/obscure`]:!!this.obscure})},this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",this.GAMEVIEWBUTTON.onclick=async a=>{a.preventDefault(),this.game=!this.game,this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",t.room.setMetadata({[`${i.EXTENSIONID}/game`]:!!this.game})},this.BREAKLENGTHBUTTON.oninput=async()=>{this.BREAKLENGTHBUTTON.value=this.BREAKLENGTHBUTTON.value.slice(0,2)},this.BREAKLENGTHBUTTON.onblur=async()=>{const a=this.BREAKLENGTHBUTTON.value??0;t.room.setMetadata({[`${i.EXTENSIONID}/time`]:a})},this.RefreshPlayerList(),await this.StartGame()}RefreshPlayerList(){const e=this.PLAYERLISTING.querySelectorAll("li");for(const s of e){const a=s.id.split("_")[1];o.party.some(n=>n.id===a)||a!==o.playerId&&s.remove()}for(const s of o.party)if(!document.getElementById(`pl_${s.id}`)){const n=document.createElement("li");n.id=`pl_${s.id}`,n.classList.add("player-list-item"),n.innerHTML=`${s.name} <div class="player-score-item" id="con_${s.connectionId}"></div>`,this.PLAYERLISTING.appendChild(n)}}StartCountdown(e){let s=e*60;this.UpdateTimer(s),this.timerId=setInterval(()=>{s--,s<=0?(clearInterval(this.timerId),this.BREAKTIMER.innerText="Time is up!"):this.UpdateTimer(s)},1e3)}UpdateTimer(e){const s=Math.floor(e/60),a=e%60,n=`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`;this.BREAKTIMER.innerText=n}async StartGame(){this.paused&&this.game?(await t.action.setHeight(this.baseHeight+400),this.BODYELEMENT.style.height="100%",document.getElementById("blockGameContainer").style.display="block",document.getElementById("blockGameControls").style.display="block",T(".block-game").blockrain({autoplay:!1,autoplayRestart:!1,theme:"candy",playText:"Pass some time during the break?",playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:async function(){await t.broadcast.sendMessage(i.SCORE,0)},onRestart:function(){},onLine:async function(e,s,a){await t.broadcast.sendMessage(i.SCORE,a)}})):(await t.action.setHeight(this.baseHeight),document.getElementById("blockGameContainer").style.display="none",document.getElementById("blockGameControls").style.display="none",this.BODYELEMENT.style.height="")}async InitiatePlayer(){this.RetrieveSettings(),await t.action.setHeight(50),document.querySelector("#app").innerHTML="<div class='header'>Enjoy your stay.</div>",this.paused&&(o.paused=!0,await t.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.obscure,disablePointerEvents:!1}))}}const m=new I("1.03");
