import{O as t,C as n,F as u,$ as I}from"./bsWorldTime-uy-e-eiY.js";class d{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerPreviousRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;paused;caches;USER_REGISTERED;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;transportHandler;scoreHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.playerPreviousRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.paused=!1,this.USER_REGISTERED=!1,this.caches=e,this.debouncedOnSceneItemsChange=m(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=m(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=m(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await t.scene.isReady(),this.theme=await t.theme.getTheme(),T(this.theme,document),this.caches.includes(d.PLAYER)&&(this.playerId=await t.player.getId(),this.playerName=await t.player.getName(),this.playerColor=await t.player.getColor(),this.playerMetadata=await t.player.getMetadata(),this.playerRole=await t.player.getRole(),this.playerPreviousRole=this.playerRole),this.caches.includes(d.PARTY)&&(this.party=await t.party.getPlayers()),this.caches.includes(d.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await t.scene.items.getItems()),this.caches.includes(d.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await t.scene.getMetadata()),this.caches.includes(d.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(d.ROOMMETA)&&(this.roomMetadata=await t.room.getMetadata(),this.paused=this.roomMetadata[`${n.EXTENSIONID}/paused`]),await this.CheckRegistration()}KillHandlers(){this.caches.includes(d.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(d.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(d.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(d.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(d.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(d.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler(),this.transportHandler!==void 0&&this.transportHandler(),this.scoreHandler!==void 0&&this.scoreHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(d.SCENEMETA)&&(this.sceneMetadataHandler=t.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(d.SCENEITEMS)&&(this.sceneItemsHandler=t.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(d.SCENEGRID)&&(this.sceneGridHandler=t.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(d.PLAYER)&&(this.playerHandler=t.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(d.PARTY)&&(this.partyHandler=t.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(d.ROOMMETA)&&(this.roomHandler=t.room.onMetadataChange(async e=>{this.roomMetadata=e,this.playerRole==="PLAYER"&&(e[`${n.EXTENSIONID}/paused`]===!0&&this.paused===!1?(this.paused=!0,await t.modal.open({id:n.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.roomMetadata[`${n.EXTENSIONID}/obscure`],disablePointerEvents:!1})):e[`${n.EXTENSIONID}/paused`]===!1&&this.paused===!0&&(this.paused=!1,await t.modal.close(n.PAUSEID))),this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=t.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=t.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await t.scene.items.getItems(),this.sceneMetadata=await t.scene.getMetadata(),this.gridDpi=await t.scene.grid.getDpi(),this.gridScale=(await t.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)})),this.transportHandler=t.broadcast.onMessage(n.TRANSPORT,async e=>{if(l.playerRole==="GM"){const a=e.connectionId,s=l.party.find(i=>i.connectionId===a);if(s){const i=`pl_${s.id}`,o=document.getElementById(i);o&&(o.style.backgroundImage=e.data===n.READY?"url(/check.svg)":"url(/cross.svg)")}}}),this.scoreHandler=t.broadcast.onMessage(n.SCORE,async e=>{const a=`con_${e.connectionId}`,s=document.getElementById(a);s&&(s.innerText=`Score: ${e.data}`)})}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e&&this.SetupHandlers()}async OnPlayerChange(e){e.role==="GM"&&this.playerPreviousRole==="PLAYER"?(E.MAINAPP.innerHTML=n.BASEHTML,await t.action.setHeight(E.baseHeight),await E.InitiateGM()):e.role==="PLAYER"&&this.playerPreviousRole==="GM"&&await E.InitiatePlayer(),this.playerPreviousRole=e.role}async OnPartyChange(e){if(this.playerRole==="GM"){const a=document.getElementById("playerList"),s=a.querySelectorAll("li");for(const i of s){const o=i.id.split("_")[1];e.some(r=>r.id===o)||o!==this.playerId&&i.remove()}for(const i of e)if(!document.getElementById(`pl_${i.id}`)){const r=document.createElement("li");r.id=`pl_${i.id}`,r.classList.add("player-list-item"),r.innerText=i.name,a.appendChild(r)}}}async OnRoomMetadataChange(e){this.oldRoomMetadata=e}async OnThemeChange(e){T(e,document)}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",a={owlbearid:l.playerId},s={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:n.ANONAUTH,"x-manuel":e}),body:JSON.stringify(a)},i=await fetch(n.CHECKREGISTRATION,s);if(!i.ok){const r=await i.json();console.error("Error:",r);return}(await i.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const l=new d([d.ROOMMETA,d.PLAYER,d.PARTY]);function g(){const c=document.createElement("img");return c.id="PatreonButton",c.setAttribute("class","icon"),c.classList.add("patreon-clickable"),c.setAttribute("title",l.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),c.setAttribute("src",l.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),c.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},c}function m(c,e){let a;return function(){clearTimeout(a),a=setTimeout(()=>{c()},e)}}function T(c,e){const a=window.matchMedia("(prefers-color-scheme: dark)"),s=a.matches?"dark":"light",i=a.matches?"light":"dark";for(var o=0;o<e.styleSheets.length;o++)for(var r=0;r<e.styleSheets[o].cssRules.length;r++){let h=e.styleSheets[o].cssRules[r];h&&h.media&&h.media.mediaText.includes("prefers-color-scheme")&&(c.mode=="LIGHT"?(h.media.appendMedium(`(prefers-color-scheme: ${s})`),h.media.mediaText.includes(i)&&h.media.deleteMedium(`(prefers-color-scheme: ${i})`)):c.mode=="DARK"&&(h.media.appendMedium(`(prefers-color-scheme: ${i})`),h.media.mediaText.includes(s)&&h.media.deleteMedium(`(prefers-color-scheme: ${s})`)))}}t.onReady(async()=>{await l.InitializeCache(),l.SetupHandlers(),l.playerRole==="PLAYER"?await E.InitiatePlayer():await E.InitiateGM(),document.getElementById("patreonContainer").appendChild(g())});class R{baseHeight=420;paused=!1;pausedAt="";obscure=!1;game=!1;selfReady;timerId;version;MAINAPP=document.getElementById("app");PLAYERLISTING=document.getElementById("playerList");PAUSEBUTTON=document.getElementById("pauseButton");HIDEVIEWBUTTON=document.getElementById("hideViewButton");GAMEVIEWBUTTON=document.getElementById("gameViewButton");BREAKLENGTHBUTTON=document.getElementById("breakLength");BREAKTIMER=document.getElementById("breakTimer");SENDMESSAGE=document.getElementById("sendMessage");MESSAGETEXT=document.getElementById("MessageTextarea");BODYELEMENT=document.getElementById("bodyElement");constructor(e){this.version=`SHORTREST-${e}`,this.selfReady=!1,this.timerId=0}RetrieveSettings(){this.paused=l.roomMetadata[`${n.EXTENSIONID}/paused`]??!1,this.pausedAt=l.roomMetadata[`${n.EXTENSIONID}/pausedAt`]??"",this.obscure=l.roomMetadata[`${n.EXTENSIONID}/obscure`]??!1,this.game=l.roomMetadata[`${n.EXTENSIONID}/game`]??!1}async InitiateGM(){this.RetrieveSettings(),this.PLAYERLISTING=document.getElementById("playerList"),this.PAUSEBUTTON=document.getElementById("pauseButton"),this.HIDEVIEWBUTTON=document.getElementById("hideViewButton"),this.GAMEVIEWBUTTON=document.getElementById("gameViewButton"),this.BREAKLENGTHBUTTON=document.getElementById("breakLength"),this.BREAKTIMER=document.getElementById("breakTimer"),this.SENDMESSAGE=document.getElementById("sendMessage"),this.MESSAGETEXT=document.getElementById("MessageTextarea"),this.BODYELEMENT=document.getElementById("bodyElement");const e=l.roomMetadata[`${n.EXTENSIONID}/time`];this.BREAKLENGTHBUTTON.value=parseInt(e)>0?e:"0";const a=document.createElement("li");if(a.id=`pl_${l.playerId}`,a.classList.add("self-list-item"),a.innerText="Self",this.PLAYERLISTING.appendChild(a),a.onclick=async s=>{s.preventDefault(),this.paused&&(this.selfReady=!this.selfReady,a.style.backgroundImage=this.selfReady?"url(/check.svg)":"url(/cross.svg)",a.innerText=this.selfReady?"Click to un-ready":"Click when ready!",await t.broadcast.sendMessage(n.TRANSPORT,this.selfReady?n.READY:n.BUSY))},this.SENDMESSAGE.onclick=async s=>{s.preventDefault(),this.MESSAGETEXT.value&&this.paused&&(await t.broadcast.sendMessage(n.MESSAGE,this.MESSAGETEXT.value),this.MESSAGETEXT.value="",this.SENDMESSAGE.classList.add("flashing-text"),setTimeout(async()=>{this.SENDMESSAGE.classList.remove("flashing-text")},1e3))},this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game",this.paused){const s=new Date(await u()),i=new Date(this.pausedAt),o=Math.round((s.getTime()-i.getTime())/1e3),h=parseInt(this.BREAKLENGTHBUTTON.value)*60-o;h>0?this.StartCountdown(h):this.BREAKTIMER.innerText="--:--";const p=this.PLAYERLISTING.querySelectorAll("li");for(const y of p)y.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";a.innerText="Click when ready!",this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused}else{const s=this.PLAYERLISTING.querySelectorAll(".player-score-item");for(const i of s)i.innerText=""}this.PAUSEBUTTON.onclick=async s=>{s.preventDefault(),this.paused=!this.paused,this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game";const i=this.PLAYERLISTING.querySelectorAll("li");for(const r of i)r.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused;const o=await u();if(t.room.setMetadata({[`${n.EXTENSIONID}/paused`]:!!this.paused,[`${n.EXTENSIONID}/pausedAt`]:o}),this.paused){const r=parseInt(this.BREAKLENGTHBUTTON.value)*60;r>0?this.StartCountdown(r):this.BREAKTIMER.innerText="--:--",a.innerText="Click when ready!",setTimeout(async()=>{this.MESSAGETEXT.value?await t.broadcast.sendMessage(n.MESSAGE,this.MESSAGETEXT.value):await t.broadcast.sendMessage(n.MESSAGE,"The session has been paused.")},2e3)}else this.BREAKTIMER.innerText="--:--",clearInterval(this.timerId),a.innerText="Self";await this.StartGame()},this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",this.HIDEVIEWBUTTON.onclick=async s=>{s.preventDefault(),this.obscure=!this.obscure,this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",t.room.setMetadata({[`${n.EXTENSIONID}/obscure`]:!!this.obscure})},this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",this.GAMEVIEWBUTTON.onclick=async s=>{s.preventDefault(),this.game=!this.game,this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",t.room.setMetadata({[`${n.EXTENSIONID}/game`]:!!this.game})},this.BREAKLENGTHBUTTON.oninput=async()=>{this.BREAKLENGTHBUTTON.value=this.BREAKLENGTHBUTTON.value.slice(0,2),this.BREAKLENGTHBUTTON.value||(this.BREAKLENGTHBUTTON.value="0")},this.BREAKLENGTHBUTTON.onblur=async()=>{const s=this.BREAKLENGTHBUTTON.value??0;this.BREAKLENGTHBUTTON.value!==s&&(this.BREAKLENGTHBUTTON.value=s),t.room.setMetadata({[`${n.EXTENSIONID}/time`]:s})},this.RefreshPlayerList(),await this.StartGame()}RefreshPlayerList(){const e=this.PLAYERLISTING.querySelectorAll("li");for(const a of e){const s=a.id.split("_")[1];l.party.some(i=>i.id===s)||s!==l.playerId&&a.remove()}for(const a of l.party)if(!document.getElementById(`pl_${a.id}`)){const i=document.createElement("li");i.id=`pl_${a.id}`,i.classList.add("player-list-item"),i.innerHTML=`${a.name} <div class="player-score-item" id="con_${a.connectionId}"></div>`,this.PLAYERLISTING.appendChild(i)}}StartCountdown(e){this.UpdateTimer(e),this.timerId=setInterval(()=>{e--,e<=0?(clearInterval(this.timerId),this.BREAKTIMER.innerText="Time is up!"):this.UpdateTimer(e)},1e3)}UpdateTimer(e){const a=Math.floor(e/60),s=e%60,i=`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`;this.BREAKTIMER.innerText=i}async StartGame(){this.paused&&this.game?(await t.action.setHeight(this.baseHeight+400),this.BODYELEMENT.style.height="100%",document.getElementById("blockGameContainer").style.display="block",document.getElementById("blockGameControls").style.display="block",I(".block-game").blockrain({autoplay:!1,autoplayRestart:!1,theme:"candy",playText:"Pass some time during the break?",playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:async function(){await t.broadcast.sendMessage(n.SCORE,0)},onRestart:function(){},onLine:async function(e,a,s){await t.broadcast.sendMessage(n.SCORE,s)}})):(await t.action.setHeight(this.baseHeight),document.getElementById("blockGameContainer").style.display="none",document.getElementById("blockGameControls").style.display="none",this.BODYELEMENT.style.height="")}async InitiatePlayer(){this.RetrieveSettings(),await t.action.setHeight(50),document.querySelector("#app").innerHTML="<div class='header'>Enjoy your stay.<div id='patreonContainer'></div></div>",this.paused&&(l.paused=!0,await t.modal.open({id:n.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.obscure,disablePointerEvents:!1}))}}const E=new R("1.03");
