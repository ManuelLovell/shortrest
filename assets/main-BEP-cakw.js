import{O as s,C as i,$ as T}from"./bsConstants-DphT7H9z.js";class d{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;playerPreviousRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;paused;caches;USER_REGISTERED;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;transportHandler;scoreHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.playerPreviousRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.paused=!1,this.USER_REGISTERED=!1,this.caches=e,this.debouncedOnSceneItemsChange=m(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=m(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=m(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await s.scene.isReady(),this.theme=await s.theme.getTheme(),u(this.theme,document),this.caches.includes(d.PLAYER)&&(this.playerId=await s.player.getId(),this.playerName=await s.player.getName(),this.playerColor=await s.player.getColor(),this.playerMetadata=await s.player.getMetadata(),this.playerRole=await s.player.getRole(),this.playerPreviousRole=this.playerRole),this.caches.includes(d.PARTY)&&(this.party=await s.party.getPlayers()),this.caches.includes(d.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await s.scene.items.getItems()),this.caches.includes(d.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await s.scene.getMetadata()),this.caches.includes(d.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await s.scene.grid.getDpi(),this.gridScale=(await s.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(d.ROOMMETA)&&(this.roomMetadata=await s.room.getMetadata(),this.paused=this.roomMetadata[`${i.EXTENSIONID}/paused`]),await this.CheckRegistration()}KillHandlers(){this.caches.includes(d.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(d.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(d.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(d.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(d.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(d.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler(),this.transportHandler!==void 0&&this.transportHandler(),this.scoreHandler!==void 0&&this.scoreHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(d.SCENEMETA)&&(this.sceneMetadataHandler=s.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(d.SCENEITEMS)&&(this.sceneItemsHandler=s.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(d.SCENEGRID)&&(this.sceneGridHandler=s.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(d.PLAYER)&&(this.playerHandler=s.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(d.PARTY)&&(this.partyHandler=s.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(d.ROOMMETA)&&(this.roomHandler=s.room.onMetadataChange(async e=>{this.roomMetadata=e,this.playerRole==="PLAYER"&&(e[`${i.EXTENSIONID}/paused`]===!0&&this.paused===!1?(this.paused=!0,await s.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.roomMetadata[`${i.EXTENSIONID}/obscure`],disablePointerEvents:!1})):e[`${i.EXTENSIONID}/paused`]===!1&&this.paused===!0&&(this.paused=!1,await s.modal.close(i.PAUSEID))),this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=s.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=s.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await s.scene.items.getItems(),this.sceneMetadata=await s.scene.getMetadata(),this.gridDpi=await s.scene.grid.getDpi(),this.gridScale=(await s.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)})),this.transportHandler=s.broadcast.onMessage(i.TRANSPORT,async e=>{if(r.playerRole==="GM"){const t=e.connectionId,n=r.party.find(a=>a.connectionId===t);if(n){const a=`pl_${n.id}`,o=document.getElementById(a);o&&(o.style.backgroundImage=e.data===i.READY?"url(/check.svg)":"url(/cross.svg)")}}}),this.scoreHandler=s.broadcast.onMessage(i.SCORE,async e=>{const t=`con_${e.connectionId}`,n=document.getElementById(t);n&&(n.innerText=`Score: ${e.data}`)})}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){this.sceneReady}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e&&this.SetupHandlers()}async OnPlayerChange(e){e.role==="GM"&&this.playerPreviousRole==="PLAYER"?(E.MAINAPP.innerHTML=i.BASEHTML,await s.action.setHeight(E.baseHeight),await E.InitiateGM()):e.role==="PLAYER"&&this.playerPreviousRole==="GM"&&await E.InitiatePlayer(),this.playerPreviousRole=e.role}async OnPartyChange(e){if(this.playerRole==="GM"){const t=document.getElementById("playerList"),n=t.querySelectorAll("li");for(const a of n){const o=a.id.split("_")[1];e.some(c=>c.id===o)||o!==this.playerId&&a.remove()}for(const a of e)if(!document.getElementById(`pl_${a.id}`)){const c=document.createElement("li");c.id=`pl_${a.id}`,c.classList.add("player-list-item"),c.innerText=a.name,t.appendChild(c)}}}async OnRoomMetadataChange(e){this.oldRoomMetadata=e}async OnThemeChange(e){u(e,document)}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",t={owlbearid:r.playerId},n={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:i.ANONAUTH,"x-manuel":e}),body:JSON.stringify(t)},a=await fetch(i.CHECKREGISTRATION,n);if(!a.ok){const c=await a.json();console.error("Error:",c);return}(await a.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const r=new d([d.ROOMMETA,d.PLAYER,d.PARTY]);function y(){const l=document.createElement("img");return l.id="PatreonButton",l.setAttribute("class","icon"),l.classList.add("patreon-clickable"),l.setAttribute("title",r.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),l.setAttribute("src",r.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),l.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},l}function m(l,e){let t;return function(){clearTimeout(t),t=setTimeout(()=>{l()},e)}}function u(l,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",a=t.matches?"light":"dark";for(var o=0;o<e.styleSheets.length;o++)for(var c=0;c<e.styleSheets[o].cssRules.length;c++){let h=e.styleSheets[o].cssRules[c];h&&h.media&&h.media.mediaText.includes("prefers-color-scheme")&&(l.mode=="LIGHT"?(h.media.appendMedium(`(prefers-color-scheme: ${n})`),h.media.mediaText.includes(a)&&h.media.deleteMedium(`(prefers-color-scheme: ${a})`)):l.mode=="DARK"&&(h.media.appendMedium(`(prefers-color-scheme: ${a})`),h.media.mediaText.includes(n)&&h.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}s.onReady(async()=>{await r.InitializeCache(),r.SetupHandlers(),r.playerRole==="PLAYER"?await E.InitiatePlayer():await E.InitiateGM(),document.getElementById("patreonContainer").appendChild(y())});class p{baseHeight=420;paused=!1;obscure=!1;game=!1;selfReady;timerId;version;MAINAPP=document.getElementById("app");PLAYERLISTING=document.getElementById("playerList");PAUSEBUTTON=document.getElementById("pauseButton");HIDEVIEWBUTTON=document.getElementById("hideViewButton");GAMEVIEWBUTTON=document.getElementById("gameViewButton");BREAKLENGTHBUTTON=document.getElementById("breakLength");BREAKTIMER=document.getElementById("breakTimer");SENDMESSAGE=document.getElementById("sendMessage");MESSAGETEXT=document.getElementById("MessageTextarea");BODYELEMENT=document.getElementById("bodyElement");constructor(e){this.version=`SHORTREST-${e}`,this.selfReady=!1,this.timerId=0}RetrieveSettings(){this.paused=r.roomMetadata[`${i.EXTENSIONID}/paused`]??!1,this.obscure=r.roomMetadata[`${i.EXTENSIONID}/obscure`]??!1,this.game=r.roomMetadata[`${i.EXTENSIONID}/game`]??!1}async InitiateGM(){this.RetrieveSettings(),this.PLAYERLISTING=document.getElementById("playerList"),this.PAUSEBUTTON=document.getElementById("pauseButton"),this.HIDEVIEWBUTTON=document.getElementById("hideViewButton"),this.GAMEVIEWBUTTON=document.getElementById("gameViewButton"),this.BREAKLENGTHBUTTON=document.getElementById("breakLength"),this.BREAKTIMER=document.getElementById("breakTimer"),this.SENDMESSAGE=document.getElementById("sendMessage"),this.MESSAGETEXT=document.getElementById("MessageTextarea"),this.BODYELEMENT=document.getElementById("bodyElement"),this.BREAKLENGTHBUTTON.value=r.roomMetadata[`${i.EXTENSIONID}/time`]??"0";const e=document.createElement("li");if(e.id=`pl_${r.playerId}`,e.classList.add("self-list-item"),e.innerText="Self",this.PLAYERLISTING.appendChild(e),e.onclick=async t=>{t.preventDefault(),this.paused&&(this.selfReady=!this.selfReady,e.style.backgroundImage=this.selfReady?"url(/check.svg)":"url(/cross.svg)",e.innerText=this.selfReady?"Click to un-ready":"Click when ready!",await s.broadcast.sendMessage(i.TRANSPORT,this.selfReady?i.READY:i.BUSY))},this.SENDMESSAGE.onclick=async t=>{t.preventDefault(),this.MESSAGETEXT.value&&this.paused&&(await s.broadcast.sendMessage(i.MESSAGE,this.MESSAGETEXT.value),this.MESSAGETEXT.value="",this.SENDMESSAGE.classList.add("flashing-text"),setTimeout(async()=>{this.SENDMESSAGE.classList.remove("flashing-text")},1e3))},this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game",this.paused){const t=parseInt(this.BREAKLENGTHBUTTON.value);t>0?this.StartCountdown(t):this.BREAKTIMER.innerText="--:--";const n=this.PLAYERLISTING.querySelectorAll("li");for(const a of n)a.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";e.innerText="Click when ready!",this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused}else{const t=this.PLAYERLISTING.querySelectorAll(".player-score-item");for(const n of t)n.innerText=""}this.PAUSEBUTTON.onclick=async t=>{t.preventDefault(),this.paused=!this.paused,this.PAUSEBUTTON.innerHTML=this.paused?"Resume</br>Game":"Pause</br>Game";const n=this.PLAYERLISTING.querySelectorAll("li");for(const a of n)a.style.backgroundImage=this.paused?"url(/cross.svg)":"url(/check.svg)";if(this.HIDEVIEWBUTTON.disabled=this.paused,this.GAMEVIEWBUTTON.disabled=this.paused,this.BREAKLENGTHBUTTON.disabled=this.paused,s.room.setMetadata({[`${i.EXTENSIONID}/paused`]:!!this.paused}),this.paused){const a=parseInt(this.BREAKLENGTHBUTTON.value);a>0?this.StartCountdown(a):this.BREAKTIMER.innerText="--:--",e.innerText="Click when ready!",setTimeout(async()=>{this.MESSAGETEXT.value?await s.broadcast.sendMessage(i.MESSAGE,this.MESSAGETEXT.value):await s.broadcast.sendMessage(i.MESSAGE,"The session has been paused.")},2e3)}else this.BREAKTIMER.innerText="--:--",clearInterval(this.timerId),e.innerText="Self";await this.StartGame()},this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",this.HIDEVIEWBUTTON.onclick=async t=>{t.preventDefault(),this.obscure=!this.obscure,this.HIDEVIEWBUTTON.innerHTML=this.obscure?"Hide View</br>Enabled":"Hide View</br>Disabled",s.room.setMetadata({[`${i.EXTENSIONID}/obscure`]:!!this.obscure})},this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",this.GAMEVIEWBUTTON.onclick=async t=>{t.preventDefault(),this.game=!this.game,this.GAMEVIEWBUTTON.innerHTML=this.game?"Mini-Game</br>Enabled":"Mini-Game</br>Disabled",s.room.setMetadata({[`${i.EXTENSIONID}/game`]:!!this.game})},this.BREAKLENGTHBUTTON.oninput=async()=>{this.BREAKLENGTHBUTTON.value=this.BREAKLENGTHBUTTON.value.slice(0,2)},this.BREAKLENGTHBUTTON.onblur=async()=>{const t=this.BREAKLENGTHBUTTON.value??0;s.room.setMetadata({[`${i.EXTENSIONID}/time`]:t})},this.RefreshPlayerList(),await this.StartGame()}RefreshPlayerList(){const e=this.PLAYERLISTING.querySelectorAll("li");for(const t of e){const n=t.id.split("_")[1];r.party.some(a=>a.id===n)||n!==r.playerId&&t.remove()}for(const t of r.party)if(!document.getElementById(`pl_${t.id}`)){const a=document.createElement("li");a.id=`pl_${t.id}`,a.classList.add("player-list-item"),a.innerHTML=`${t.name} <div class="player-score-item" id="con_${t.connectionId}"></div>`,this.PLAYERLISTING.appendChild(a)}}StartCountdown(e){let t=e*60;this.UpdateTimer(t),this.timerId=setInterval(()=>{t--,t<=0?(clearInterval(this.timerId),this.BREAKTIMER.innerText="Time is up!"):this.UpdateTimer(t)},1e3)}UpdateTimer(e){const t=Math.floor(e/60),n=e%60,a=`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}`;this.BREAKTIMER.innerText=a}async StartGame(){this.paused&&this.game?(await s.action.setHeight(this.baseHeight+400),this.BODYELEMENT.style.height="100%",document.getElementById("blockGameContainer").style.display="block",document.getElementById("blockGameControls").style.display="block",T(".block-game").blockrain({autoplay:!1,autoplayRestart:!1,theme:"candy",playText:"Pass some time during the break?",playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:async function(){await s.broadcast.sendMessage(i.SCORE,0)},onRestart:function(){},onLine:async function(e,t,n){await s.broadcast.sendMessage(i.SCORE,n)}})):(await s.action.setHeight(this.baseHeight),document.getElementById("blockGameContainer").style.display="none",document.getElementById("blockGameControls").style.display="none",this.BODYELEMENT.style.height="")}async InitiatePlayer(){this.RetrieveSettings(),await s.action.setHeight(50),document.querySelector("#app").innerHTML="<div class='header'>Enjoy your stay.<div id='patreonContainer'></div></div>",this.paused&&(r.paused=!0,await s.modal.open({id:i.PAUSEID,url:"/pausescreen.html",fullScreen:!0,hideBackdrop:!1,hidePaper:!this.obscure,disablePointerEvents:!1}))}}const E=new p("1.03");
